<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 <mapper namespace="org.zerock.mapper.MainMapper">
 
 <!--  회원가입 -->
 <insert id="signup" parameterType="org.zerock.domain.MemberVO">
 insert into member(num,name,email,password)
 values(member_seq.nextval,#{name},#{email},#{password})
 </insert>
 
 <select id="idcheck" parameterType="String" resultType="int">
 select count(*) from member where email = #{email}
 </select>
 
 <select id="login" parameterType="String" resultType="org.zerock.domain.MemberVO">
 select * from member where email = #{email}
 </select>
 
 <insert id="createAuthKey" parameterType="org.zerock.domain.EmailVO">
	insert into email(num,membernum,email,authkey,tf) values(email_seq.nextval,#{membernum},#{email}, #{authkey}, 0)
</insert>

<update id="userAuth">
	update user set userCertification = 1 where (select count(*) from userAuth where userEmail = #{userEmail}) > 0
</update>

<select id="getMembernum" parameterType="String" resultType="int">
	select num from member where email = #{email}
</select>

<select id="authkeyselect" parameterType="int" resultType="org.zerock.domain.EmailVO">
	select * from email where num = (select max(num) from email where membernum = #{membernum})
</select>

<select id="passcheck" parameterType="String" resultType="org.zerock.domain.MemberVO">
	select * from member where email = #{email}
</select>

<update id="passupdate">
	update member set password = #{pwd} where num = #{num} 
</update>

<insert id="incomeInsert" parameterType="org.zerock.domain.HouseholdVO">
	insert into household(num,membernum,division,money,regdate,content,category) values(income_seq.nextval,#{membernum},#{division},#{money},#{regdate},#{content},#{category})
</insert>

<select id="tableList" parameterType="int" resultType="org.zerock.domain.HouseholdVO">
	select * from household where membernum = #{membernum}
</select>

<select id="getIncome" parameterType="org.zerock.domain.HouseholdVO" resultType="int">
	select sum(money) from household where SUBSTR(regdate,6,2) = #{month} and membernum = #{membernum} GROUP BY category having category = '수입'
</select>

<select id="getDx" parameterType="org.zerock.domain.HouseholdVO" resultType="int">
	select sum(money) from household where SUBSTR(regdate,6,2) = #{month} and membernum = #{membernum} GROUP BY category having category = '지출'
</select>

<select id="getMonthincome" parameterType = "org.zerock.domain.HouseholdVO" resultType="int">
	select sum(money) from household where SUBSTR(regdate,6,2) = #{month} and membernum = #{membernum} and category = '지출'
</select>

<select id="pieRank" parameterType="org.zerock.domain.HouseholdVO" resultType="org.zerock.domain.HouseholdVO">
	<![CDATA[
	select rank1, division, money from (select rank() OVER (ORDER BY sum(money) DESC) as rank1, 
	division, sum(money) money from household where SUBSTR(regdate,6,2) = #{month} and category = '지출' and membernum = #{membernum} group by division) 
	where rank1 <= 3
	]]>
</select>

<select id="barRank" parameterType="org.zerock.domain.HouseholdVO" resultType="org.zerock.domain.HouseholdVO">
	<![CDATA[
	select rank1, division, money from (select rank() OVER (ORDER BY sum(money) DESC) as rank1, 
	division, sum(money) money from household where SUBSTR(regdate,6,2) = #{month} and category = '지출' and membernum = #{membernum} group by division) 
	where rank1 <= 5
	]]>
</select>

 </mapper>